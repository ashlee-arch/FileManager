<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <title>FileManager</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fff; }
    .center-page { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding: 24px 16px; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 56px 20px; }

    .brand { text-align:center; margin-bottom: 16px; }
    .logo { font-size: 40px; font-weight: 800; letter-spacing: -0.6px; }
    .desc { margin-top: 10px; color: #4b5563; }

    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 22px; background:#fff; }
    .card.narrow { width: min(680px, 100%); }

    label { display:block; font-size: 13px; color:#374151; margin: 10px 0 6px; }
    input[type="text"], input[type="password"], input[type="file"] {
      width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px;
      box-sizing: border-box;
    }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .btn { background:#111827; color: #fff; }
    .btn2 { background:#f3f4f6; color:#111827; }
    .muted { color:#6b7280; font-size: 13px; margin-top: 10px; }
    .link { color:#2563eb; text-decoration:none; }
    hr { border: 0; border-top: 1px solid #e5e7eb; margin: 18px 0; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 10px; }
    ul { padding-left: 18px; }
    li { margin: 10px 0; }
    small { color:#6b7280; margin-left: 6px; }

    /* 상태 메시지 */
    .msg { margin-top: 12px; padding: 10px 12px; border-radius: 10px; font-size: 13px; }
    .msg.err { background:#fef2f2; color:#991b1b; border: 1px solid #fecaca; }
    .msg.ok  { background:#f0fdf4; color:#166534; border: 1px solid #bbf7d0; }
    .msg.warn{ background:#fffbeb; color:#92400e; border: 1px solid #fde68a; }
  </style>
</head>

<body>

<!-- 비로그인 -->
<div class="center-page" sec:authorize="isAnonymous()">
  <div class="card narrow">
    <div class="brand">
      <div class="logo">FileManager</div>
      <div class="desc">파일을 업로드해서 관리해보세요!</div>
    </div>

    <h2 style="margin:0 0 12px;">로그인</h2>

    <form th:action="@{/login}" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <label for="username">아이디</label>
      <input id="username" type="text" name="username" autocomplete="username" required />

      <label for="password">비밀번호</label>
      <input id="password" type="password" name="password" autocomplete="current-password" required />

      <div class="msg err" th:if="${param.error}">아이디 또는 비밀번호가 올바르지 않습니다.</div>
      <div class="msg ok" th:if="${param.logout}">로그아웃 되었습니다.</div>

      <div style="margin-top:14px;">
        <button class="btn" type="submit">로그인</button>
        <a class="link" th:href="@{/signup}" style="margin-left:10px;">회원가입</a>
      </div>
    </form>

    <hr>
    <div class="muted">(참고) DB 확인: <a class="link" href="/h2-console" target="_blank">/h2-console</a></div>
  </div>
</div>

<!-- 로그인 후 -->
<div class="wrap" sec:authorize="isAuthenticated()">
  <div class="logo">FileManager</div>
  <div class="desc">파일을 업로드해서 관리해보세요!</div>

  <div class="card" style="margin-top:18px;">
    <div class="muted" style="margin-top:0;">
      <b sec:authentication="name"></b> 님 환영합니다.
      &nbsp;|&nbsp;
      <form th:action="@{/logout}" method="post" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn2">로그아웃</button>
      </form>
    </div>

    <!-- ✅ 상태 메시지(업로드/삭제/권한/에러) -->
    <div class="msg ok" th:if="${param.uploaded}">업로드가 완료되었습니다.</div>
    <div class="msg ok" th:if="${param.deleted}">삭제가 완료되었습니다.</div>
    <div class="msg warn" th:if="${param.forbidden}">권한이 없어 요청을 처리할 수 없습니다.</div>
    <div class="msg err" th:if="${param.error}">요청 처리 중 오류가 발생했습니다. (예: 업로드 실패)</div>

    <hr>

    <h2 style="margin-top:0;">자료 등록</h2>
    <form th:action="@{/upload}" method="post" enctype="multipart/form-data">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <div class="row">
        <div>
          <label>제목</label>
          <input type="text" name="title" required />
        </div>
        <div>
          <label>파일</label>
          <input type="file" name="file" required />
        </div>
      </div>

      <div style="margin-top:14px;">
        <button class="btn" type="submit">등록</button>
      </div>
    </form>

    <hr>

    <h2>자료 목록</h2>
    <div class="muted" th:if="${docs == null || #lists.isEmpty(docs)}">아직 업로드된 파일이 없습니다.</div>

    <ul th:if="${docs != null && !#lists.isEmpty(docs)}">
      <li th:each="d : ${docs}">
        <b th:text="${d.title}">제목</b>
        (
          <!-- ✅ 목록에는 원본 파일명만 보이게 -->
          <a class="link"
             th:href="@{/download/{id}(id=${d.id})}"
             th:text="${d.originalFilename}">파일명</a>
        )
        <small th:text="${#temporals.format(d.createdAt, 'yyyy-MM-dd HH:mm')}"></small>

        <form th:action="@{/delete/{id}(id=${d.id})}" method="post" style="display:inline;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button class="btn2" type="submit">삭제</button>
        </form>
      </li>
    </ul>

    <hr>
    <div class="muted">DB 확인: <a class="link" href="/h2-console" target="_blank">/h2-console</a></div>
  </div>
</div>

</body>
</html>
